#+TITLE: el-igo - Emacs Go Game(SGF) Editor
#+OPTIONS: toc:nil num:nil ^:nil

Emacs内で囲碁の盤面を表示し、棋譜(SGF形式)を編集します。

[[file:./screenshot/igo-org.gif]]

* 動作環境
Emacs 27.1

* org-mode文書内に棋譜を埋め込む(igo-org.el)
** 設定
init.elに次のコードを追加してください。

#+begin_src emacs-lisp
(with-eval-after-load "org"
  (require 'igo-org)
  (igo-org-setup))
#+end_src

** 使い方
org文書内にigo特殊ブロックを挿入します。(操作例: C-c C-, SPC i g o RET)

#+begin_src org
,#+begin_igo
,#+end_igo
#+end_src

ブロックの中に (;SZ[9]) と入力すると9路盤が表示されます。またはブロック内で C-c i を押すと盤面サイズを指定して初期化できるようになっています。

後は適当に石を置いたり、フリー編集モードで初期盤面を設定したり(現在はルートノードのみ編集可能)、コメントを設定したりすると、その操作毎にバッファのテキストが書き換わります。

** ブロック毎のオプション

=#+begin_igo= の後にブロック毎のオプションを指定できます。

例えば次のようにするとブロックが盤面化されたとき(orgファイルを開いたとき等)に最初から手順番号が表示されます。

#+begin_src org
,#+begin_igo :move-number t
(;FF[4]GM[1]SZ[9];B[fd];W[df];B[ff];W[dd])
,#+end_igo
#+end_src

有効なオプションには次のものがあります。

| オプション名 | 意味                        | 値                         |
|--------------+-----------------------------+----------------------------|
| :status-bar  | ステータスバーの表示状態    | nil, noのとき非表示        |
| :move-number | 手順番号の表示状態          | nil, noのとき非表示        |
| :branch-text | 分岐文字(A,B,...)の表示状態 | nil, noのとき非表示        |
| :editable    | 編集可能                    | nil, noのとき編集不可能    |
| :read-only   | 編集禁止(:editableの逆)     | nil, noのとき編集可能      |
| :path        | 最初に表示する盤面(ノード)  | 盤面へたどり着く経路(後述) |

*** :pathの指定方法

:path オプションは最初に表示する盤面(ゲーム木のノード)を指定します。

パス(盤面へたどり着く経路)は次の要素を並べたもので、最初の盤面(ルート)から各要素が指定する盤面を順番にたどり最終的に到達した盤面が選択されます。

| 数字                       | 現在の盤面から数字で指定しただけ後の盤面(途中分岐がある場合は最初の分岐(A)を選択)(無い場合は最後の盤面) |
| -数字                      | 現在の盤面から数字で指定しただけ前の盤面(無い場合は最初の盤面)                                          |
| アルファベット二文字       | SGF座標とみなし、その場所に打つ現在の盤面から最も近い盤面(幅優先探索)                                   |
| 大文字アルファベット一文字 | 現在の盤面以降の最初の分岐での分岐先(A:0, B:1, ...)を指定したものと見なし、その分岐直後の盤面           |
| \under{} (アンダーバー)    | 現在の盤面以降の最初の分岐がある盤面(分岐が無ければ最後の盤面)                                          |

例:
- 0 : 最初の盤面
- 12 : 最初から12手目の盤面
- cd : 最初に3の4に着手する盤面
- cc/fc : 最初に左上三々(cc)に着手した後、次に最初に二間開き(fc)した盤面
- cc/2 : 最初に着手した後の2手目
- A/B/A : 分岐をA、B、Aの順に選択した盤面
- _ : 最初の分岐(無ければ最後の盤面)
- _/-1 : 最初の分岐(無ければ最後の盤面)の一つ前

** HTMLでのエクスポート

特殊ブロックなのでHTMLエスクポート時には<div class="igo"><p>～</p></div>で囲まれたSGFテキストが出力されます。

盤面の形で表示させたい場合は、ページ読み込み完了時にJavaScriptで一括変換するのが簡単でしょう。

例えば拙作のJavaScript碁盤を使用するならば [[https://github.com/misohena/js_igo][misohena/js_igo: JavaScript Go Game Board]] より igo.js, igo_view.js, igo.css をダウンロードした上で、次のようにします。

#+begin_src org
,#+HTML_HEAD: <script src="igo.js"></script>
,#+HTML_HEAD: <script src="igo_view.js"></script>
,#+HTML_HEAD: <link rel="stylesheet" href="igo.css" />
,#+HTML_HEAD: <script>window.addEventListener("load", ev=>{ for(elem of document.querySelectorAll("div.igo")){ let sgf = elem.textContent; while(elem.hasChildNodes()){elem.removeChild(elem.firstChild);} new igo.GameView(elem, sgf, {"showBranchText": true, "showLastMoveMark": true, "showComment": true, "path":1000}); }});</script>

お互いに二連星したところ。

,#+begin_igo
(;FF[4]GM[1]SZ[9];B[fd];W[df];B[ff];W[dd])
,#+end_igo
#+end_src

特殊ブロックの出力自体を変える方法もあります。ox-html.elのorg-html-special-block関数にadviceを仕込むか、htmlエクスポータから派生した独自のエクスポータを作るかになると思います。

* SGFファイルの編集(igo-sgf-mode.el)
** 設定
init.elに次のコードを追加してください。

#+begin_src emacs-lisp
(autoload 'igo-sgf-mode "igo-sgf-mode")
(add-to-list 'auto-mode-alist '("\\.sgf$" . igo-sgf-mode))
#+end_src

sgfファイルを開くと自動的に盤面が表示されます。

注意: sgfファイルはオセロ、チェス、バックギャモンなど囲碁以外のゲームの棋譜も表現できます。あなたがそれらを扱う場合は、GMプロパティが1以外のときにigo-sgf-modeを起動しないようにする必要があります(未実装)。

* バッファ内の任意の部分を盤面にする(igo-editor.el)

任意のSGFテキストをリージョンで囲った上で M-x igo-edit-region を実行すると、その範囲がエディタ化されます。

igo-sgf-mode.el も igo-org.el も igo-editor.el を使って実装されています。igo-sgf-mode.elはバッファ全体を、igo-org.elはbegin_igo～end_igoの間を自動的にエディタ化します。

* エディタの使い方
** モード
エディタは大きく分けて次のようなモードを持っています。

- テキストモード
  - 固定モード(エラーが無くなってもテキストのまま)
  - 自動回復モード(エラーが無くなったときに自動的にグラフィカルモードに移行する)
- グラフィカルモード
  - 着手モード(Move Mode)
  - フリー編集モード(Free Edit Mode)
  - マーク編集モード(Mark Edit Mode)

テキストモードとグラフィカルモードとの間は C-c g で行き来できます。

グラフィカルモードでは「編集モード」によって盤面クリック時の動作を含めた操作体系が変わります。

** キー操作
各モードで使えるキー操作は次の通りです。

*** テキストモード

| 操作  | 説明                     | 関数                      |
|-------+--------------------------+---------------------------|
| C-c q | エディタの終了           | igo-editor-quit           |
| C-c g | グラフィカルモードへ移行 | igo-editor-graphical-mode |
| C-c i | 盤面の初期化             | igo-editor-init-board     |

*** グラフィカルモード共通

| 操作                      | 説明                                   | 関数                          |
|---------------------------+----------------------------------------+-------------------------------|
| C-g, t                    | テキストモードへ移行                   | igo-editor-text-mode          |
| C-x c-q                   | 編集可能状態切り替え                   | igo-editor-toggle-editable    |
|---------------------------+----------------------------------------+-------------------------------|
| a, \vert{}<ボタンクリック | 最初へ                                 | igo-editor-first-node         |
| e, >\vert{}ボタンクリック | 最後へ(デフォルト選択でたどれる所まで) | igo-editor-last-node          |
| b, <ボタンクリック        | 前へ                                   | igo-editor-previous-node      |
| f, >ボタンクリック        | 次へ(デフォルト選択でたどれる場合)     | igo-editor-next-node          |
| M-b                       | 前の分岐地点へ                         | igo-editor-previous-fork      |
| M-f                       | 次の分岐地点へ                         | igo-editor-next-fork          |
| n                         | 次の盤面を分岐の中から選択して表示     | igo-editor-select-next-node   |
|---------------------------+----------------------------------------+-------------------------------|
| Q                         | 着手モード                             | igo-editor-move-mode          |
| F                         | フリー編集モード                       | igo-editor-free-edit-mode     |
| M                         | マーク編集モード                       | igo-editor-mark-edit-mode     |
|---------------------------+----------------------------------------+-------------------------------|
| s s                       | ステータスバー表示切り替え             | igo-editor-toggle-status-bar  |
| s n                       | 手順番号表示切り替え                   | igo-editor-toggle-move-number |
| s b                       | 分岐表示切り替え                       | igo-editor-toggle-branch-text |
|---------------------------+----------------------------------------+-------------------------------|
| c                         | コメントの編集                         | igo-editor-edit-comment       |
| g                         | 対局情報の編集                         | igo-editor-edit-game-info     |
| C-c i                     | 盤面の初期化                           | igo-editor-init-board         |

*** 着手モード

| 操作                  | 説明                                 | 関数                               |
|-----------------------+--------------------------------------+------------------------------------|
| P, Passボタンクリック | パス                                 | igo-editor-pass                    |
| p                     | 石を置く                             | igo-editor-put-stone               |
| 盤面をクリック        | 石を置く                             | igo-editor-move-mode-board-click   |
| Passボタン右クリック  | 着手「パス」に対するメニューを表示   | igo-editor-pass-click-r            |
| 盤面を右クリック      | 交点(石や空点)に対するメニューを表示 | igo-editor-move-mode-board-click-r |

*** フリー編集モード

(現在の所、一番最初の盤面でのみ使用できます)

| 操作                   | 説明                     | 関数                             |
|------------------------+--------------------------+----------------------------------|
| Quitボタンクリック     | 着手モードへ切り替え     | igo-editor-move-mode             |
| 盤面をクリック         | 交点を選択中の状態にする | igo-editor-free-edit-board-click |
| B, Blackボタンクリック | 黒石を選択する           | igo-editor-free-edit-black       |
| W, Whiteボタンクリック | 白石を選択する           | igo-editor-free-edit-white       |
| E, Emptyボタンクリック | 空点を選択する           | igo-editor-free-edit-empty       |
| T, Turnボタンクリック  | 次の手番を反転させる     | igo-editor-free-edit-toggle-turn |

*** マーク編集モード

| 操作                  | 説明                     | 関数                             |
|-----------------------+--------------------------+----------------------------------|
| Quitボタンクリック    | 着手モードへ切り替え     | igo-editor-move-mode             |
| 盤面をクリック        | 交点を選択中の状態にする | igo-editor-mark-edit-board-click |
| X, Xボタンクリック    | ×マークを選択する       | igo-editor-mark-edit-cross       |
| O, Oボタンクリック    | ○マークを選択する       | igo-editor-mark-edit-circle      |
| S, SQボタンクリック   | □マークを選択する       | igo-editor-mark-edit-square      |
| T, TRボタンクリック   | △マークを選択する       | igo-editor-mark-edit-triangle    |
| E, Textボタンクリック | テキストを選択する       | igo-editor-mark-edit-text        |
| D, Delボタンクリック  | 消去を選択する           | igo-editor-mark-edit-del         |

** 分岐の編集

前の手に戻って別の場所に打つと自動的に分岐が作られます。エディタは全ての分岐をツリー構造で記録しています。

分岐は分岐直前の盤面でAから始まるアルファベットで表示されます。

分岐箇所を示すアルファベットを「左クリック」すると、その分岐に進みます。

「次へ進む」ボタンは最後に選んだ分岐へ進みますが、もしまだ選択していない場合は明示的に指定する必要があります。

分岐を削除したい場合や分岐の(アルファベットの)順番を変更したい場合は、アルファベットを *「右クリック」* してください。分岐に対する操作がポップアップメニューで表示されます。
